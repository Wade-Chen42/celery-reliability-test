# Redis Configuration for Celery Reliability Testing

# 基本配置
bind 0.0.0.0
protected-mode no
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

# 持久化配置 - RDB
# 900 秒內至少 1 個 key 改變
save 900 1
# 300 秒內至少 10 個 key 改變  
save 300 10
# 60 秒內至少 10000 個 key 改變
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# 持久化配置 - AOF
# 啟用 AOF
appendonly yes
appendfilename "appendonly.aof"
# 每秒同步一次（平衡性能與安全）
appendfsync everysec
# 每次寫入都同步（最安全但最慢）
# appendfsync always
# 由 OS 決定何時同步（最快但最不安全）
# appendfsync no
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# 記憶體管理
maxmemory 256mb
# 當記憶體滿時，刪除最少使用的 key
maxmemory-policy allkeys-lru

# 日誌
loglevel notice
logfile ""

# 慢查詢日誌
slowlog-log-slower-than 10000
slowlog-max-len 128

# 客戶端連線
maxclients 10000

# 其他優化
hz 10
dynamic-hz yes
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes

# 監控
latency-monitor-threshold 100

# 危險命令重命名（生產環境建議）
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command CONFIG ""